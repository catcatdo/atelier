{% extends 'base.html' %}

{% block title %}{% if editing %}Edit{% else %}New{% endif %} Post â€” Atelier des Poupees{% endblock %}

{% block content %}
<section class="max-w-2xl mx-auto px-4 py-12">
    <div class="bg-white rounded-lg border-double border-4 border-charcoal/10 shadow-xl p-6 sm:p-8">
        <div class="text-center mb-8">
            <p class="font-display italic text-gold text-sm tracking-[0.2em] mb-2">
                {% if editing %}Edit{% else %}New{% endif %} Creation
            </p>
            <h1 class="font-heading text-2xl text-charcoal tracking-wide">
                {% if editing %}EDIT POST{% else %}CREATE NEW POST{% endif %}
            </h1>
            <div class="w-16 h-0.5 bg-gold mx-auto mt-4"></div>
        </div>

        {% if form.errors %}
        <div class="mb-6 p-4 bg-velvet/5 border border-velvet/20 rounded text-sm text-velvet">
            <ul class="space-y-1 list-none">
                {% for field, errors in form.errors.items %}
                    {% for error in errors %}
                    <li>{{ field|title }}: {{ error }}</li>
                    {% endfor %}
                {% endfor %}
            </ul>
        </div>
        {% endif %}

        <form method="post" enctype="multipart/form-data" class="space-y-6">
            {% csrf_token %}

            <!-- Title -->
            <div>
                <label for="id_title" class="block text-xs font-heading tracking-[0.15em] text-charcoal mb-2">TITLE</label>
                <input type="text" name="title" id="id_title" value="{{ form.title.value|default:'' }}" required
                       placeholder="Enter title..."
                       class="w-full px-4 py-2.5 bg-parchment border border-charcoal/15 rounded focus:border-gold focus:ring-1 focus:ring-gold outline-none transition text-charcoal">
            </div>

            <!-- Category & Price -->
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <label for="id_category" class="block text-xs font-heading tracking-[0.15em] text-charcoal mb-2">CATEGORY</label>
                    <select name="category" id="id_category" required
                            class="w-full px-4 py-2.5 bg-parchment border border-charcoal/15 rounded focus:border-gold focus:ring-1 focus:ring-gold outline-none transition text-charcoal">
                        <option value="">Select a category</option>
                        {% for cat in form.category.field.queryset %}
                        <option value="{{ cat.pk }}" {% if form.category.value|stringformat:"s" == cat.pk|stringformat:"s" %}selected{% endif %}>
                            {{ cat.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label for="id_price" class="block text-xs font-heading tracking-[0.15em] text-charcoal mb-2">PRICE ($)</label>
                    <input type="number" name="price" id="id_price" step="0.01" min="0" required
                           value="{{ form.price.value|default:'' }}" placeholder="0.00"
                           class="w-full px-4 py-2.5 bg-parchment border border-charcoal/15 rounded focus:border-gold focus:ring-1 focus:ring-gold outline-none transition text-charcoal">
                </div>
            </div>

            <!-- Stock & Featured -->
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <label for="id_stock" class="block text-xs font-heading tracking-[0.15em] text-charcoal mb-2">STOCK QUANTITY</label>
                    <input type="number" name="stock" id="id_stock" min="0" required
                           value="{{ form.stock.value|default:'1' }}" placeholder="1"
                           class="w-full px-4 py-2.5 bg-parchment border border-charcoal/15 rounded focus:border-gold focus:ring-1 focus:ring-gold outline-none transition text-charcoal">
                </div>
                <div class="flex items-end pb-1">
                    <label class="flex items-center gap-3 cursor-pointer">
                        <input type="checkbox" name="is_featured" {% if form.is_featured.value %}checked{% endif %}
                               class="w-5 h-5 rounded border-charcoal/20 text-gold focus:ring-gold">
                        <span class="text-xs font-heading tracking-[0.15em] text-charcoal">FEATURE ON HOMEPAGE</span>
                    </label>
                </div>
            </div>

            <!-- Image -->
            <div>
                <label for="id_image" class="block text-xs font-heading tracking-[0.15em] text-charcoal mb-2">
                    IMAGE {% if editing %}(leave empty to keep current){% endif %}
                </label>
                {% if editing and product.image %}
                <div class="mb-3 w-32 h-32 rounded overflow-hidden border border-charcoal/10">
                    <img src="{{ product.image.url }}" alt="Current" class="w-full h-full object-cover">
                </div>
                {% endif %}
                <input type="file" name="image" id="id_image" accept="image/*"
                       class="w-full text-sm text-charcoal/50
                              file:mr-4 file:py-2 file:px-4 file:rounded file:border-0
                              file:text-xs file:bg-leather file:text-parchment
                              hover:file:bg-leather-light file:font-heading file:tracking-wider file:cursor-pointer">
            </div>

            <!-- Gallery Images -->
            <div>
                <label class="block text-xs font-heading tracking-[0.15em] text-charcoal mb-2">
                    GALLERY IMAGES <span class="text-charcoal/30 font-body">(multiple select possible)</span>
                </label>
                {% if editing and product.images.exists %}
                <div class="grid grid-cols-4 sm:grid-cols-6 gap-2 mb-3">
                    {% for img in product.images.all %}
                    <div class="relative group aspect-square rounded overflow-hidden border border-charcoal/10">
                        <img src="{{ img.image.url }}" alt="" class="w-full h-full object-cover">
                        <a href="{% url 'manage_image_delete' img.pk %}"
                           class="absolute inset-0 bg-velvet/70 flex items-center justify-center opacity-0 group-hover:opacity-100 transition"
                           onclick="return confirm('Delete this image?')">
                            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </a>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
                <input type="file" name="gallery" multiple accept="image/*"
                       class="w-full text-sm text-charcoal/50
                              file:mr-4 file:py-2 file:px-4 file:rounded file:border-0
                              file:text-xs file:bg-leather file:text-parchment
                              hover:file:bg-leather-light file:font-heading file:tracking-wider file:cursor-pointer">
            </div>

            <!-- Content Images (click to insert) -->
            <div>
                <label class="block text-xs font-heading tracking-[0.15em] text-charcoal mb-2">
                    CONTENT IMAGES <span class="text-charcoal/30 font-body">(click image to insert at cursor position)</span>
                </label>
                {% if editing and product.content_images.exists %}
                <div class="grid grid-cols-3 sm:grid-cols-4 gap-2 mb-3">
                    {% for img in product.content_images.all %}
                    <div class="relative group">
                        <div class="aspect-square rounded overflow-hidden border-2 border-charcoal/10 cursor-pointer hover:border-gold transition content-img-thumb"
                             onclick="insertTag('[img:{{ img.number }}]')"
                             title="Click to insert [img:{{ img.number }}] at cursor">
                            <img src="{{ img.image.url }}" alt="" class="w-full h-full object-cover">
                            <div class="absolute inset-0 bg-gold/0 hover:bg-gold/20 transition flex items-center justify-center">
                                <span class="opacity-0 group-hover:opacity-100 transition bg-charcoal/70 text-parchment text-xs px-2 py-1 rounded font-mono">
                                    [img:{{ img.number }}]
                                </span>
                            </div>
                        </div>
                        <a href="{% url 'manage_content_image_delete' img.pk %}"
                           class="absolute -top-1.5 -right-1.5 bg-velvet text-white w-5 h-5 rounded-full flex items-center justify-center text-xs opacity-0 group-hover:opacity-100 transition z-10 shadow"
                           onclick="return confirm('Delete?')">x</a>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
                <input type="file" name="content_images" multiple accept="image/*"
                       class="w-full text-sm text-charcoal/50
                              file:mr-4 file:py-2 file:px-4 file:rounded file:border-0
                              file:text-xs file:bg-leather file:text-parchment
                              hover:file:bg-leather-light file:font-heading file:tracking-wider file:cursor-pointer">
                <p class="text-xs text-charcoal/30 mt-1">
                    Upload images first, then click them to insert at cursor position in the content below.
                </p>
            </div>

            <!-- Content -->
            <div>
                <label for="id_content" class="block text-xs font-heading tracking-[0.15em] text-charcoal mb-2">CONTENT</label>
                <textarea name="content" id="id_content" rows="15" required
                          placeholder="Write your description and story...&#10;&#10;Click content images above to place them between paragraphs."
                          class="w-full px-4 py-3 bg-parchment border border-charcoal/15 rounded focus:border-gold focus:ring-1 focus:ring-gold outline-none transition resize-y text-charcoal leading-relaxed font-mono text-sm">{{ form.content.value|default:'' }}</textarea>
            </div>

            <script>
            function insertTag(tag) {
                var ta = document.getElementById('id_content');
                var start = ta.selectionStart;
                var end = ta.selectionEnd;
                var text = ta.value;
                ta.value = text.substring(0, start) + tag + text.substring(end);
                ta.selectionStart = ta.selectionEnd = start + tag.length;
                ta.focus();
                // Flash feedback on textarea
                ta.style.borderColor = '#D4AF37';
                setTimeout(function() { ta.style.borderColor = ''; }, 500);
            }
            </script>

            <!-- Buttons -->
            <div class="flex flex-col sm:flex-row gap-3 pt-2">
                <button type="submit"
                        class="flex-1 bg-leather text-parchment py-3 px-8 font-heading tracking-[0.15em] text-sm hover:bg-leather-light transition rounded shadow-md">
                    {% if editing %}UPDATE POST{% else %}PUBLISH POST{% endif %}
                </button>
                <a href="{% url 'manage_dashboard' %}"
                   class="text-center border border-charcoal/20 text-charcoal py-3 px-8 font-heading tracking-[0.15em] text-xs hover:border-gold hover:text-gold transition rounded">
                    CANCEL
                </a>
            </div>
        </form>
    </div>
</section>
{% endblock %}
