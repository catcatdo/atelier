{% extends 'base.html' %}

{% block title %}{% if editing %}Edit{% else %}New{% endif %} Banner — Atelier des Poupees{% endblock %}

{% block content %}
<section class="max-w-4xl mx-auto px-4 py-12">
    <div class="bg-white rounded-lg border-double border-4 border-charcoal/10 shadow-xl p-6 sm:p-8">
        <div class="text-center mb-8">
            <p class="font-display italic text-gold text-sm tracking-[0.2em] mb-2">
                {% if editing %}Edit{% else %}New{% endif %} Hero Banner
            </p>
            <h1 class="font-heading text-2xl text-charcoal tracking-wide">
                {% if editing %}EDIT BANNER{% else %}CREATE BANNER{% endif %}
            </h1>
            <div class="w-16 h-0.5 bg-gold mx-auto mt-4"></div>
        </div>

        {% if form.errors %}
        <div class="mb-6 p-4 bg-velvet/5 border border-velvet/20 rounded text-sm text-velvet">
            <ul class="space-y-1 list-none">
                {% for field, errors in form.errors.items %}
                    {% for error in errors %}
                    <li>{{ field|title }}: {{ error }}</li>
                    {% endfor %}
                {% endfor %}
            </ul>
        </div>
        {% endif %}

        <form method="post" enctype="multipart/form-data" class="space-y-6" id="banner-form">
            {% csrf_token %}

            <!-- Step 1: Image Upload -->
            <div>
                <label for="id_image" class="block text-xs font-heading tracking-[0.15em] text-charcoal mb-2">
                    STEP 1: BANNER IMAGE {% if editing %}(leave empty to keep current){% endif %}
                </label>
                <input type="file" name="image" id="id_image" accept="image/*"
                       class="w-full text-sm text-charcoal/50
                              file:mr-4 file:py-2 file:px-4 file:rounded file:border-0
                              file:text-xs file:bg-leather file:text-parchment
                              hover:file:bg-leather-light file:font-heading file:tracking-wider file:cursor-pointer">
            </div>

            <!-- Step 2: Crop -->
            <div id="crop-container" class="hidden">
                <label class="block text-xs font-heading tracking-[0.15em] text-charcoal mb-2">STEP 2: CROP</label>
                <div class="border border-charcoal/15 rounded overflow-hidden bg-charcoal/5" style="max-height: 450px;">
                    <img id="crop-preview" src="" alt="Preview" style="max-width: 100%; display: block;">
                </div>
                <div class="flex items-center gap-4 mt-3">
                    <label class="text-xs text-charcoal/50">Ratio:</label>
                    <select id="aspect-select" class="text-sm px-3 py-1.5 bg-parchment border border-charcoal/15 rounded focus:border-gold outline-none text-charcoal">
                        <option value="2.5">5:2 (Wide)</option>
                        <option value="1.777">16:9</option>
                        <option value="1.333">4:3</option>
                        <option value="0">Free</option>
                    </select>
                    <span id="crop-size" class="text-xs text-charcoal/40"></span>
                    <button type="button" id="crop-done-btn" class="ml-auto bg-gold text-charcoal px-4 py-1.5 rounded text-xs font-heading tracking-wider hover:bg-gold/80 transition">
                        DONE &rarr; ADD TEXT
                    </button>
                </div>
            </div>

            <!-- Hidden fields -->
            <input type="hidden" name="crop_x" id="id_crop_x" value="{{ form.crop_x.value|default:'0' }}">
            <input type="hidden" name="crop_y" id="id_crop_y" value="{{ form.crop_y.value|default:'0' }}">
            <input type="hidden" name="crop_width" id="id_crop_width" value="{{ form.crop_width.value|default:'0' }}">
            <input type="hidden" name="crop_height" id="id_crop_height" value="{{ form.crop_height.value|default:'0' }}">
            <input type="hidden" name="text_overlays" id="id_text_overlays" value='{% if editing %}{{ banner.text_overlays }}{% else %}[]{% endif %}'>

            <!-- Step 3: Text Overlay Editor -->
            <div id="text-editor-section" class="{% if not editing or not banner.image %}hidden{% endif %}">
                <label class="block text-xs font-heading tracking-[0.15em] text-charcoal mb-2">STEP 3: TEXT OVERLAYS</label>

                <!-- Add Text Input -->
                <div class="flex gap-2 mb-3">
                    <input type="text" id="new-text-input" placeholder="Enter text here..."
                           class="flex-1 px-4 py-2.5 bg-parchment border border-charcoal/15 rounded focus:border-gold focus:ring-1 focus:ring-gold outline-none transition text-charcoal">
                    <button type="button" id="add-text-btn"
                            class="bg-leather text-parchment px-4 py-2.5 rounded text-xs font-heading tracking-wider hover:bg-leather-light transition whitespace-nowrap">
                        + ADD
                    </button>
                </div>

                <!-- Toolbar -->
                <div class="flex flex-wrap items-center gap-2 mb-3 p-3 bg-parchment rounded border border-charcoal/10">
                    <span class="text-xs text-charcoal/40 mr-1">Selected:</span>
                    <select id="font-select" class="text-xs px-2 py-1.5 bg-white border border-charcoal/15 rounded focus:border-gold outline-none text-charcoal">
                        <option value="Cinzel">Cinzel</option>
                        <option value="Playfair Display">Playfair Display</option>
                        <option value="Inter">Inter</option>
                        <option value="Noto Serif KR">Noto Serif KR</option>
                        <option value="Noto Sans KR">Noto Sans KR</option>
                    </select>
                    <input type="number" id="size-input" value="32" min="8" max="200" step="1"
                           class="w-16 text-xs px-2 py-1.5 bg-white border border-charcoal/15 rounded focus:border-gold outline-none text-charcoal text-center"
                           title="Font size (px)">
                    <span class="text-xs text-charcoal/40">px</span>
                    <input type="color" id="color-input" value="#D4AF37"
                           class="w-8 h-8 rounded border border-charcoal/15 cursor-pointer">
                    <label class="flex items-center gap-1 text-xs text-charcoal/60 cursor-pointer">
                        <input type="checkbox" id="bold-check" class="w-4 h-4 rounded">
                        <span class="font-bold">B</span>
                    </label>
                    <label class="flex items-center gap-1 text-xs text-charcoal/60 cursor-pointer">
                        <input type="checkbox" id="shadow-check" checked class="w-4 h-4 rounded">
                        Shadow
                    </label>
                    <button type="button" id="delete-text-btn"
                            class="ml-auto text-velvet text-xs hover:text-red-700 transition font-heading tracking-wider">
                        DELETE
                    </button>
                </div>

                <!-- Text list -->
                <div id="text-list" class="mb-3 space-y-1"></div>

                <!-- Canvas Area -->
                <div id="editor-canvas" class="relative rounded-lg overflow-hidden border-2 border-charcoal/20 bg-charcoal cursor-crosshair select-none"
                     style="min-height: 250px; aspect-ratio: 2.5/1;">
                    {% if editing and banner.image %}
                    <img id="canvas-bg" src="{{ banner.image.url }}" alt=""
                         class="w-full h-full object-cover block pointer-events-none absolute inset-0">
                    {% else %}
                    <img id="canvas-bg" src="" alt=""
                         class="w-full h-full object-cover block pointer-events-none absolute inset-0 hidden">
                    {% endif %}
                    <div id="text-layer" class="absolute inset-0 overflow-hidden"></div>
                </div>
                <p class="text-xs text-charcoal/30 mt-2">Drag text to reposition. Double-click to edit. Click to select.</p>
            </div>

            <!-- Title -->
            <div>
                <label for="id_title" class="block text-xs font-heading tracking-[0.15em] text-charcoal mb-2">BANNER TITLE <span class="text-charcoal/30 font-body">(admin reference)</span></label>
                <input type="text" name="title" id="id_title" value="{{ form.title.value|default:'' }}"
                       placeholder="Banner title..."
                       class="w-full px-4 py-2.5 bg-parchment border border-charcoal/15 rounded focus:border-gold focus:ring-1 focus:ring-gold outline-none transition text-charcoal">
            </div>

            <input type="hidden" name="subtitle" value="{{ form.subtitle.value|default:'' }}">

            <!-- Link URL -->
            <div>
                <label for="id_link_url" class="block text-xs font-heading tracking-[0.15em] text-charcoal mb-2">LINK URL <span class="text-charcoal/30 font-body">(optional)</span></label>
                <input type="url" name="link_url" id="id_link_url" value="{{ form.link_url.value|default:'' }}"
                       placeholder="https://..."
                       class="w-full px-4 py-2.5 bg-parchment border border-charcoal/15 rounded focus:border-gold focus:ring-1 focus:ring-gold outline-none transition text-charcoal">
            </div>

            <!-- Order & Active -->
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <label for="id_display_order" class="block text-xs font-heading tracking-[0.15em] text-charcoal mb-2">DISPLAY ORDER</label>
                    <input type="number" name="display_order" id="id_display_order" min="0"
                           value="{{ form.display_order.value|default:'0' }}" placeholder="0"
                           class="w-full px-4 py-2.5 bg-parchment border border-charcoal/15 rounded focus:border-gold focus:ring-1 focus:ring-gold outline-none transition text-charcoal">
                </div>
                <div class="flex items-end pb-1">
                    <label class="flex items-center gap-3 cursor-pointer">
                        <input type="checkbox" name="is_active" {% if form.is_active.value or not editing %}checked{% endif %}
                               class="w-5 h-5 rounded border-charcoal/20 text-gold focus:ring-gold">
                        <span class="text-xs font-heading tracking-[0.15em] text-charcoal">ACTIVE</span>
                    </label>
                </div>
            </div>

            <!-- Buttons -->
            <div class="flex flex-col sm:flex-row gap-3 pt-2">
                <button type="submit"
                        class="flex-1 bg-leather text-parchment py-3 px-8 font-heading tracking-[0.15em] text-sm hover:bg-leather-light transition rounded shadow-md">
                    {% if editing %}UPDATE BANNER{% else %}CREATE BANNER{% endif %}
                </button>
                <a href="{% url 'manage_dashboard' %}"
                   class="text-center border border-charcoal/20 text-charcoal py-3 px-8 font-heading tracking-[0.15em] text-xs hover:border-gold hover:text-gold transition rounded">
                    CANCEL
                </a>
            </div>
        </form>
    </div>
</section>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>

<script>
(function() {
    // ── Elements ──
    var cropper = null;
    var originalDataUrl = null;
    var imageInput = document.getElementById('id_image');
    var cropContainer = document.getElementById('crop-container');
    var cropPreview = document.getElementById('crop-preview');
    var aspectSelect = document.getElementById('aspect-select');
    var cropSizeEl = document.getElementById('crop-size');
    var cropDoneBtn = document.getElementById('crop-done-btn');
    var editorSection = document.getElementById('text-editor-section');
    var canvasBg = document.getElementById('canvas-bg');
    var textLayer = document.getElementById('text-layer');
    var editorCanvas = document.getElementById('editor-canvas');
    var textListEl = document.getElementById('text-list');

    // ── State ──
    var overlays = [];
    var selectedIdx = -1;
    var dragState = null;

    // Load existing overlays
    try {
        overlays = JSON.parse(document.getElementById('id_text_overlays').value || '[]');
        if (!Array.isArray(overlays)) overlays = [];
    } catch(e) { overlays = []; }

    // ═══ CROPPER ═══

    function initCropper(src) {
        originalDataUrl = src;
        cropContainer.classList.remove('hidden');
        editorSection.classList.add('hidden');
        cropPreview.src = src;
        if (cropper) cropper.destroy();
        cropper = new Cropper(cropPreview, {
            aspectRatio: parseFloat(aspectSelect.value) || NaN,
            viewMode: 1,
            autoCropArea: 1,
            responsive: true,
            crop: function(e) {
                var d = e.detail;
                cropSizeEl.textContent = Math.round(d.width) + ' x ' + Math.round(d.height) + ' px';
            }
        });
    }

    imageInput.addEventListener('change', function(e) {
        var file = e.target.files[0];
        if (!file) return;
        var reader = new FileReader();
        reader.onload = function(ev) { initCropper(ev.target.result); };
        reader.readAsDataURL(file);
    });

    aspectSelect.addEventListener('change', function() {
        if (cropper) cropper.setAspectRatio(parseFloat(this.value) || NaN);
    });

    cropDoneBtn.addEventListener('click', function() {
        if (!cropper) return;

        var data = cropper.getData(true);
        document.getElementById('id_crop_x').value = data.x;
        document.getElementById('id_crop_y').value = data.y;
        document.getElementById('id_crop_width').value = data.width;
        document.getElementById('id_crop_height').value = data.height;

        // Generate cropped preview with size limit to avoid canvas issues
        try {
            var croppedCanvas = cropper.getCroppedCanvas({ maxWidth: 1600, maxHeight: 900 });
            if (croppedCanvas) {
                canvasBg.src = croppedCanvas.toDataURL('image/jpeg', 0.85);
                canvasBg.classList.remove('hidden');
            }
        } catch(err) {
            // Fallback: show original image with CSS crop simulation
            if (originalDataUrl) {
                canvasBg.src = originalDataUrl;
                canvasBg.classList.remove('hidden');
            }
        }

        cropContainer.classList.add('hidden');
        editorSection.classList.remove('hidden');
    });

    // ═══ TEXT OVERLAY EDITOR ═══

    function saveOverlays() {
        document.getElementById('id_text_overlays').value = JSON.stringify(overlays);
    }

    function renderTextList() {
        textListEl.innerHTML = '';
        overlays.forEach(function(ov, i) {
            var row = document.createElement('div');
            row.className = 'flex items-center gap-2 px-3 py-1.5 rounded text-sm cursor-pointer transition '
                + (i === selectedIdx ? 'bg-gold/20 border border-gold' : 'bg-charcoal/5 border border-transparent hover:bg-charcoal/10');
            row.innerHTML = '<span class="w-3 h-3 rounded-full flex-shrink-0" style="background:' + ov.color + '"></span>'
                + '<span class="flex-1 truncate" style="font-family:' + ov.font + '">' + ov.text + '</span>'
                + '<span class="text-xs text-charcoal/30">' + ov.size + 'px</span>';
            row.addEventListener('click', function() { selectOverlay(i); });
            textListEl.appendChild(row);
        });
    }

    function renderCanvas() {
        textLayer.innerHTML = '';
        overlays.forEach(function(ov, i) {
            var el = document.createElement('div');
            el.style.cssText = 'position:absolute;cursor:move;user-select:none;white-space:nowrap;line-height:1.2;letter-spacing:0.05em;'
                + 'left:' + ov.x + '%;top:' + ov.y + '%;'
                + 'font-family:' + ov.font + ';font-size:' + ov.size + 'px;color:' + ov.color + ';'
                + 'font-weight:' + (ov.bold ? 'bold' : 'normal') + ';';
            if (ov.shadow) el.style.textShadow = '2px 2px 8px rgba(0,0,0,0.7)';
            if (i === selectedIdx) {
                el.style.outline = '2px dashed #D4AF37';
                el.style.outlineOffset = '4px';
            }
            el.textContent = ov.text;

            el.addEventListener('mousedown', function(e) { e.stopPropagation(); selectOverlay(i); startDrag(e, i); });
            el.addEventListener('touchstart', function(e) { e.stopPropagation(); selectOverlay(i); startTouchDrag(e, i); }, { passive: false });
            el.addEventListener('dblclick', function(e) {
                e.stopPropagation();
                var t = prompt('Edit text:', ov.text);
                if (t !== null && t !== '') { overlays[i].text = t; render(); saveOverlays(); }
            });
            textLayer.appendChild(el);
        });
    }

    function render() {
        renderCanvas();
        renderTextList();
    }

    function selectOverlay(idx) {
        selectedIdx = idx;
        render();
        if (idx >= 0 && idx < overlays.length) {
            var ov = overlays[idx];
            document.getElementById('font-select').value = ov.font;
            document.getElementById('size-input').value = ov.size;
            document.getElementById('color-input').value = ov.color;
            document.getElementById('bold-check').checked = ov.bold;
            document.getElementById('shadow-check').checked = ov.shadow;
        }
    }

    // ── Drag ──
    function startDrag(e, idx) {
        var rect = editorCanvas.getBoundingClientRect();
        dragState = { idx: idx, sx: e.clientX, sy: e.clientY, ox: overlays[idx].x, oy: overlays[idx].y, w: rect.width, h: rect.height };
        document.addEventListener('mousemove', onDrag);
        document.addEventListener('mouseup', endDrag);
    }
    function onDrag(e) {
        if (!dragState) return;
        overlays[dragState.idx].x = Math.max(0, Math.min(95, dragState.ox + ((e.clientX - dragState.sx) / dragState.w) * 100));
        overlays[dragState.idx].y = Math.max(0, Math.min(95, dragState.oy + ((e.clientY - dragState.sy) / dragState.h) * 100));
        renderCanvas();
    }
    function endDrag() { dragState = null; document.removeEventListener('mousemove', onDrag); document.removeEventListener('mouseup', endDrag); saveOverlays(); renderTextList(); }

    function startTouchDrag(e, idx) {
        var t = e.touches[0], rect = editorCanvas.getBoundingClientRect();
        dragState = { idx: idx, sx: t.clientX, sy: t.clientY, ox: overlays[idx].x, oy: overlays[idx].y, w: rect.width, h: rect.height };
        document.addEventListener('touchmove', onTouchDrag, { passive: false });
        document.addEventListener('touchend', endTouchDrag);
    }
    function onTouchDrag(e) {
        if (!dragState) return; e.preventDefault();
        var t = e.touches[0];
        overlays[dragState.idx].x = Math.max(0, Math.min(95, dragState.ox + ((t.clientX - dragState.sx) / dragState.w) * 100));
        overlays[dragState.idx].y = Math.max(0, Math.min(95, dragState.oy + ((t.clientY - dragState.sy) / dragState.h) * 100));
        renderCanvas();
    }
    function endTouchDrag() { dragState = null; document.removeEventListener('touchmove', onTouchDrag); document.removeEventListener('touchend', endTouchDrag); saveOverlays(); renderTextList(); }

    // ── Click canvas to deselect ──
    editorCanvas.addEventListener('mousedown', function(e) {
        if (e.target === editorCanvas || e.target === canvasBg || e.target === textLayer) selectOverlay(-1);
    });

    // ── Add text ──
    var newTextInput = document.getElementById('new-text-input');
    document.getElementById('add-text-btn').addEventListener('click', addText);
    newTextInput.addEventListener('keydown', function(e) { if (e.key === 'Enter') { e.preventDefault(); addText(); } });

    function addText() {
        var text = newTextInput.value.trim();
        if (!text) { newTextInput.focus(); return; }
        overlays.push({
            text: text,
            x: 5 + (overlays.length % 3) * 10,
            y: 20 + (overlays.length % 5) * 12,
            font: document.getElementById('font-select').value,
            size: parseInt(document.getElementById('size-input').value) || 32,
            color: document.getElementById('color-input').value,
            bold: document.getElementById('bold-check').checked,
            shadow: document.getElementById('shadow-check').checked
        });
        newTextInput.value = '';
        newTextInput.focus();
        selectOverlay(overlays.length - 1);
        saveOverlays();
    }

    // ── Delete ──
    document.getElementById('delete-text-btn').addEventListener('click', function() {
        if (selectedIdx < 0) return;
        overlays.splice(selectedIdx, 1);
        selectedIdx = -1;
        render(); saveOverlays();
    });

    // ── Toolbar changes ──
    ['font-select', 'size-input', 'color-input', 'bold-check', 'shadow-check'].forEach(function(id) {
        document.getElementById(id).addEventListener(id.includes('check') ? 'change' : 'input', function() {
            if (selectedIdx < 0) return;
            var ov = overlays[selectedIdx];
            ov.font = document.getElementById('font-select').value;
            ov.size = parseInt(document.getElementById('size-input').value) || 32;
            ov.color = document.getElementById('color-input').value;
            ov.bold = document.getElementById('bold-check').checked;
            ov.shadow = document.getElementById('shadow-check').checked;
            render(); saveOverlays();
        });
    });

    // ── Submit ──
    document.getElementById('banner-form').addEventListener('submit', function() {
        if (cropper && cropContainer.style.display !== 'none' && !cropContainer.classList.contains('hidden')) {
            var data = cropper.getData(true);
            document.getElementById('id_crop_x').value = data.x;
            document.getElementById('id_crop_y').value = data.y;
            document.getElementById('id_crop_width').value = data.width;
            document.getElementById('id_crop_height').value = data.height;
        }
        saveOverlays();
    });

    // ── Initial render ──
    render();
})();
</script>
{% endblock %}
